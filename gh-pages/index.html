<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Accomplishments Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --text: #eee;
      --text-muted: #aaa;
      --border: #333;
      --accent: #0f3460;
      --accent-bright: #e94560;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-bright) 100%);
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    header h1 {
      margin: 0 0 15px 0;
      font-size: 2em;
    }

    .date-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .date-controls input,
    .date-controls button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      font-size: 14px;
    }

    .date-controls input {
      background: rgba(255,255,255,0.9);
      color: #333;
    }

    .date-controls button {
      background: rgba(255,255,255,0.2);
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }

    .date-controls button:hover { background: rgba(255,255,255,0.3); }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .metric-card {
      background: var(--surface);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .metric-card h3 {
      margin: 0 0 10px 0;
      font-size: 0.9em;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .metric-value {
      font-size: 2em;
      font-weight: bold;
      color: var(--accent-bright);
    }

    .metric-label {
      font-size: 0.9em;
      color: var(--text-muted);
      margin-top: 5px;
    }

    .section {
      background: var(--surface);
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .section h2 {
      margin: 0 0 20px 0;
      font-size: 1.5em;
      border-bottom: 2px solid var(--accent-bright);
      padding-bottom: 10px;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }

    .session-list { list-style: none; padding: 0; }

    .session-item {
      background: var(--accent);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      border-left: 4px solid var(--accent-bright);
    }

    .session-item strong {
      color: var(--accent-bright);
      font-size: 1.1em;
    }

    .session-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
      color: var(--text-muted);
    }

    .focus-window {
      background: var(--accent);
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 5px;
      border-left: 4px solid #4ade80;
    }

    .focus-window strong { color: #4ade80; }

    @keyframes spin { to { transform: rotate(360deg); } }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .error {
      background: rgba(233, 69, 96, 0.2);
      border: 1px solid var(--accent-bright);
      padding: 20px;
      border-radius: 5px;
      text-align: center;
      color: var(--accent-bright);
    }

    .hero-score {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--surface) 100%);
      border-radius: 10px;
      margin-bottom: 30px;
    }

    .hero-score .score {
      font-size: 4em;
      font-weight: bold;
      color: var(--accent-bright);
      margin: 0;
    }

    .hero-score .rating {
      font-size: 1.5em;
      color: var(--text-muted);
      margin: 10px 0;
    }

    .score-components {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .score-component { text-align: center; }

    .score-component .value {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--accent-bright);
    }

    .score-component .label {
      font-size: 0.9em;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .metrics-grid { grid-template-columns: 1fr; }
      .metric-card { border-left: 4px solid var(--accent-bright); }
      .hero-score .score { font-size: 3em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìä Daily Accomplishments</h1>
      <div class="date-controls">
        <button id="prevDay">‚Üê Previous</button>
        <input type="date" id="datePicker">
        <button id="nextDay">Next ‚Üí</button>
        <span id="dateSubtitle" style="margin-left: 15px; opacity: 0.9;"></span>
      </div>
    </header>

    <div id="loadingIndicator" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Loading your day...</p>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="dashboard"></div>
  </div>

  <script>
    let currentDate = null;
    let charts = {};

    function formatDateFriendly(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.getTime() === today.getTime()) return 'Today';
      if (date.getTime() === yesterday.getTime()) return 'Yesterday';

      return date.toLocaleDateString('en-US', {
        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
      });
    }

    function basePrefixForPages() {
      // If hosted under /DailyAccomplishments/ on GitHub Pages, we need to prefix fetches.
      // Locally (http://localhost:8000/) we do not.
      const parts = window.location.pathname.split('/').filter(Boolean);
      if (parts.length > 0 && window.location.hostname.includes('github.io')) {
        return '/' + parts[0];
      }
      return '';
    }

    async function fetchJsonWithCacheBust(url) {
      const sep = url.includes('?') ? '&' : '?';
      const res = await fetch(`${url}${sep}t=${Date.now()}`);
      return res;
    }

    async function loadData(date) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const errorMessage = document.getElementById('errorMessage');
      const dashboard = document.getElementById('dashboard');

      loadingIndicator.style.display = 'block';
      errorMessage.style.display = 'none';
      dashboard.innerHTML = '';

      const base = basePrefixForPages();

      try {
        // Primary: repo root JSON produced by the workflow
        let response = await fetchJsonWithCacheBust(`${base}/ActivityReport-${date}.json`);

        // Fallback: if you ever also publish a date folder under reports/
        if (!response.ok) {
          response = await fetchJsonWithCacheBust(`${base}/reports/${date}/ActivityReport-${date}.json`);
        }

        if (!response.ok) throw new Error('Report not found');

        const data = await response.json();
        renderDashboard(data);

        document.getElementById('dateSubtitle').textContent = formatDateFriendly(date);
      } catch (error) {
        errorMessage.innerHTML = `
          <h3>üì≠ No report found for ${formatDateFriendly(date)}</h3>
          <p>Expected one of these files:</p>
          <p><code>ActivityReport-${date}.json</code> or <code>reports/${date}/ActivityReport-${date}.json</code></p>
        `;
        errorMessage.style.display = 'block';
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    function safe(obj, path, fallback) {
      try {
        return path.split('.').reduce((o, k) => (o && o[k] !== undefined ? o[k] : undefined), obj) ?? fallback;
      } catch {
        return fallback;
      }
    }

    function renderDashboard(data) {
      const dashboard = document.getElementById('dashboard');

      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};

      const score = safe(data, 'productivity_score', {});
      const interruptions = safe(data, 'interruption_analysis', {});
      const categories = safe(data, 'category_trends', { categories: [] });
      const meetings = safe(data, 'meeting_efficiency', {});
      const sessions = safe(data, 'deep_work_sessions', []);
      const windows = safe(data, 'focus_windows', []);

      let html = '';

      const overallScore = safe(score, 'overall_score', 'N/A');
      const rating = safe(score, 'rating', '');
      const deepWorkScore = safe(score, 'components.deep_work_score', 'N/A');
      const interruptionScore = safe(score, 'components.interruption_score', 'N/A');
      const qualityScore = safe(score, 'components.quality_score', 'N/A');

      html += `
        <div class="hero-score">
          <div class="score">${overallScore}</div>
          <div class="rating">${rating}</div>
          <div class="score-components">
            <div class="score-component">
              <div class="value">${deepWorkScore}</div>
              <div class="label">Deep Work</div>
            </div>
            <div class="score-component">
              <div class="value">${interruptionScore}</div>
              <div class="label">Interruptions</div>
            </div>
            <div class="score-component">
              <div class="value">${qualityScore}</div>
              <div class="label">Quality</div>
            </div>
          </div>
        </div>
      `;

      html += `
        <div class="metrics-grid">
          <div class="metric-card">
            <h3>Deep Work Time</h3>
            <div class="metric-value">${safe(score,'metrics.deep_work_minutes','0')}</div>
            <div class="metric-label">minutes</div>
          </div>
          <div class="metric-card">
            <h3>Focus Percentage</h3>
            <div class="metric-value">${safe(score,'metrics.deep_work_percentage','0')}%</div>
            <div class="metric-label">of total time</div>
          </div>
          <div class="metric-card">
            <h3>Interruptions</h3>
            <div class="metric-value">${safe(interruptions,'total_interruptions','0')}</div>
            <div class="metric-label">context switches</div>
          </div>
          <div class="metric-card">
            <h3>Meetings</h3>
            <div class="metric-value">${safe(meetings,'meeting_count','0')}</div>
            <div class="metric-label">${safe(meetings,'total_meeting_minutes','0')} minutes</div>
          </div>
        </div>
      `;

      html += `<div class="section"><h2>üéØ Deep Work Sessions</h2>`;
      if (sessions.length > 0) {
        html += '<ul class="session-list">';
        sessions.forEach((session, i) => {
          const start = safe(session,'start_time',null);
          const startLabel = start ? new Date(start).toLocaleTimeString() : '';
          html += `
            <li class="session-item">
              <strong>${i + 1}. ${safe(session,'app','')}</strong> - ${safe(session,'duration_minutes','0')} minutes
              <div class="session-details">
                <div>Started: ${startLabel}</div>
                <div>Interruptions: ${safe(session,'interruptions','0')}</div>
                <div>Quality: ${safe(session,'quality_score','N/A')}/100</div>
              </div>
            </li>
          `;
        });
        html += '</ul>';
      } else {
        html += '<p style="color: var(--text-muted);">No deep work sessions detected.</p>';
      }
      html += '</div>';

      html += `
        <div class="section">
          <h2>üìÇ Time by Category</h2>
          <div class="chart-container">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>
      `;

      html += `
        <div class="section">
          <h2>‚ö° Interruption Analysis</h2>
          <p><strong>Total:</strong> ${safe(interruptions,'total_interruptions','0')} interruptions</p>
          <p><strong>Context Switch Cost:</strong> ${safe(interruptions,'context_switch_cost_minutes','0')} minutes</p>
          <div class="chart-container">
            <canvas id="interruptionsChart"></canvas>
          </div>
        </div>
      `;

      html += `
        <div class="section">
          <h2>ü§ù Meeting Efficiency</h2>
          <p><strong>Total Meetings:</strong> ${safe(meetings,'meeting_count','0')}</p>
          <p><strong>Total Time:</strong> ${safe(meetings,'total_meeting_minutes','0')} minutes</p>
          ${safe(meetings,'meeting_count',0) > 0 ? `
            <p><strong>Average Duration:</strong> ${safe(meetings,'average_duration_minutes','0')} minutes</p>
            <p><strong>Meeting/Focus Ratio:</strong> ${safe(meetings,'meeting_vs_focus_ratio','')}</p>
          ` : ''}
          <p><strong>Recommendation:</strong> ${safe(meetings,'recommendation','')}</p>
        </div>
      `;

      html += `<div class="section"><h2>üí° Suggested Focus Windows</h2>`;
      if (windows.length > 0) {
        windows.forEach(w => {
          html += `
            <div class="focus-window">
              <strong>${safe(w,'start_time','')} - ${safe(w,'end_time','')}</strong> (${safe(w,'duration_hours','0')} hours)
              <div style="margin-top: 5px; font-size: 0.9em;">
                Quality: ${safe(w,'quality','')} | Interruptions: ${safe(w,'total_interruptions','0')}
                <br>${safe(w,'recommendation','')}
              </div>
            </div>
          `;
        });
      } else {
        html += '<p style="color: var(--text-muted);">No optimal focus windows identified.</p>';
      }
      html += '</div>';

      dashboard.innerHTML = html;

      const cats = safe(categories,'categories',[]);
      if (cats.length > 0) {
        const ctx1 = document.getElementById('categoryChart').getContext('2d');
        charts.categoryChart = new Chart(ctx1, {
          type: 'doughnut',
          data: {
            labels: cats.map(c => c.category),
            datasets: [{
              data: cats.map(c => c.time_minutes),
              backgroundColor: ['#e94560','#0f3460','#16213e','#533483','#f39c12','#27ae60']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#eee' } } }
          }
        });
      }

      const perHour = safe(interruptions,'interruptions_per_hour',{});
      if (Object.keys(perHour).length > 0) {
        const ctx2 = document.getElementById('interruptionsChart').getContext('2d');
        const hours = Object.keys(perHour).sort((a, b) => Number(a) - Number(b));
        charts.interruptionsChart = new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: hours.map(h => `${h}:00`),
            datasets: [{
              label: 'Interruptions',
              data: hours.map(h => perHour[h]),
              backgroundColor: '#e94560'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#eee' } } },
            scales: {
              y: { beginAtZero: true, ticks: { color: '#aaa' }, grid: { color: '#333' } },
              x: { ticks: { color: '#aaa' }, grid: { color: '#333' } }
            }
          }
        });
      }
    }

    function init() {
      const today = new Date();
      currentDate = today.toISOString().split('T')[0];

      document.getElementById('datePicker').value = currentDate;
      loadData(currentDate);

      document.getElementById('datePicker').addEventListener('change', (e) => {
        currentDate = e.target.value;
        loadData(currentDate);
      });

      document.getElementById('prevDay').addEventListener('click', () => {
        const date = new Date(currentDate + 'T00:00:00');
        date.setDate(date.getDate() - 1);
        currentDate = date.toISOString().split('T')[0];
        document.getElementById('datePicker').value = currentDate;
        loadData(currentDate);
      });

      document.getElementById('nextDay').addEventListener('click', () => {
        const date = new Date(currentDate + 'T00:00:00');
        date.setDate(date.getDate() + 1);
        currentDate = date.toISOString().split('T')[0];
        document.getElementById('datePicker').value = currentDate;
        loadData(currentDate);
      });
    }

    window.onload = init;
  </script>
</body>
</html>