<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Today | Daily Accomplishments</title>
  <style>
    :root{
      --bg:#0a0a0f;
      --panel:#0f172a;
      --panel2:#0b1220;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --dim:#64748b;
      --line:rgba(148,163,184,.18);
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#111827;
      --chipLine:rgba(148,163,184,.22);
      --focus:#60a5fa;
      --btn:#111827;
      --btnHover:#172554;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .light{
      --bg:#f8fafc;
      --panel:#ffffff;
      --panel2:#f1f5f9;
      --text:#0f172a;
      --muted:#475569;
      --dim:#64748b;
      --line:rgba(15,23,42,.12);
      --chip:#ffffff;
      --chipLine:rgba(15,23,42,.16);
      --btn:#0f172a;
      --btnHover:#1e293b;
      --shadow: 0 10px 30px rgba(2,6,23,.10);
    }

    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.14), transparent 60%),
                  radial-gradient(1000px 500px at 80% 20%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      line-height:1.35;
    }
    a{color:inherit;}
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 18px 60px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:42px;height:42px;
      border-radius:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.35), rgba(34,197,94,.22));
      display:flex;align-items:center;justify-content:center;
      box-shadow: var(--shadow);
      border:1px solid rgba(148,163,184,.16);
      font-size:20px;
    }
    h1{
      font-size:18px;
      margin:0;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:13px;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(17,24,39,.65);
      color:var(--text);
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .light .btn{ background: rgba(15,23,42,.05); }
    .btn:hover{ background: rgba(23,37,84,.55); border-color: rgba(96,165,250,.35); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(37,99,235,.25);
      border-color: rgba(96,165,250,.45);
    }
    .btn.danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }
    .dateRow{
      display:flex;
      align-items:center;
      gap:8px;
    }
    input[type="date"]{
      background: rgba(17,24,39,.65);
      border:1px solid rgba(148,163,184,.22);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      font-size:13px;
      outline:none;
    }
    .light input[type="date"]{ background: rgba(15,23,42,.04); color: var(--text); }
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .95fr;
      gap:14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      header{ flex-direction:column; align-items:stretch; }
      .controls{ justify-content:flex-start; }
    }
    .card{
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(2,6,23,.55));
      border:1px solid rgba(148,163,184,.16);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .light .card{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(241,245,249,.75));
    }
    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cardHeader h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
    }
    .cardBody{ padding:14px 16px; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      background: rgba(17,24,39,.55);
      border:1px solid var(--chipLine);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
    }
    .light .chip{ background: rgba(15,23,42,.03); }
    .chip b{ color: var(--text); font-weight:600; }
    .meter{
      display:flex; align-items:center; gap:10px;
      margin-top: 10px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--dim);
      box-shadow: 0 0 0 3px rgba(148,163,184,.12);
      flex: 0 0 auto;
    }
    .dot.good{ background: var(--good); box-shadow: 0 0 0 3px rgba(34,197,94,.18); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.18); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.18); }
    .meterText{
      color: var(--muted);
      font-size:13px;
    }
    .timeline{
      display:grid;
      grid-template-columns: repeat(24, 1fr);
      gap:4px;
      margin-top: 12px;
    }
    .hour{
      height: 16px;
      border-radius: 6px;
      background: rgba(148,163,184,.12);
      border: 1px solid rgba(148,163,184,.10);
    }
    .hour.on{
      background: rgba(96,165,250,.35);
      border-color: rgba(96,165,250,.25);
    }
    .legendRow{
      display:flex;
      justify-content:space-between;
      margin-top: 8px;
      color: var(--dim);
      font-size:11px;
    }

    .accompTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .accompTop .hint{
      color: var(--muted);
      font-size:12px;
    }
    .list{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background: rgba(2,6,23,.15);
    }
    .light .item{ background: rgba(241,245,249,.55); }
    .row{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px 12px;
    }
    .rowLeft{
      display:flex;
      align-items:flex-start;
      gap:10px;
      flex: 1 1 auto;
      min-width: 0;
    }
    .pill{
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      color: var(--muted);
      background: rgba(17,24,39,.45);
      flex: 0 0 auto;
      margin-top: 1px;
    }
    .light .pill{ background: rgba(15,23,42,.03); }
    .text{
      font-size:14px;
      color: var(--text);
      outline:none;
      min-width: 0;
      word-break: break-word;
    }
    .text[contenteditable="true"]{
      border-radius:10px;
      padding:4px 6px;
      margin: -4px -6px;
    }
    .text[contenteditable="true"]:focus{
      box-shadow: 0 0 0 3px rgba(96,165,250,.20);
      background: rgba(96,165,250,.10);
    }
    .rowBtns{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
    }
    .mini{
      border:1px solid rgba(148,163,184,.22);
      background: rgba(17,24,39,.45);
      color: var(--text);
      padding:7px 9px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
    }
    .light .mini{ background: rgba(15,23,42,.03); }
    .mini:hover{ border-color: rgba(96,165,250,.35); background: rgba(23,37,84,.45); }
    .mini:active{ transform: translateY(1px); }
    .mini.hide{ opacity:.85; }
    .mini.del{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); }
    details{
      border-top:1px solid var(--line);
      padding: 10px 12px 12px;
    }
    summary{
      cursor:pointer;
      color: var(--muted);
      font-size:12px;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .receipts{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:13px;
      color: var(--muted);
    }
    .receipt{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border: 1px solid rgba(148,163,184,.14);
      background: rgba(17,24,39,.22);
      padding:8px 10px;
      border-radius:12px;
      flex-wrap:wrap;
    }
    .light .receipt{ background: rgba(15,23,42,.03); }
    .receipt b{ color: var(--text); font-weight:600; }
    .rightCol .cardBody{ padding-top: 12px; }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:9px 0;
      border-bottom:1px solid var(--line);
      font-size:13px;
    }
    .kv:last-child{ border-bottom:none; }
    .k{ color: var(--muted); }
    .v{ color: var(--text); font-weight:600; }
    .smallNote{
      margin-top: 10px;
      font-size:12px;
      color: var(--muted);
    }
    textarea{
      width:100%;
      min-height:120px;
      resize: vertical;
      border-radius:12px;
      padding:10px 12px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(17,24,39,.45);
      color: var(--text);
      font-family: inherit;
      font-size:13px;
      outline:none;
    }
    .light textarea{ background: rgba(15,23,42,.03); color: var(--text); }
    textarea:focus{ box-shadow: 0 0 0 3px rgba(96,165,250,.20); border-color: rgba(96,165,250,.35); }

    .toast{
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(2,6,23,.88);
      border: 1px solid rgba(148,163,184,.22);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      transform: translateX(-50%) translateY(6px);
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .mutedLink{
      color: var(--muted);
      font-size:12px;
      text-decoration: none;
      border-bottom: 1px dotted rgba(148,163,184,.35);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">‚úÖ</div>
        <div>
          <h1>Today</h1>
          <div class="sub" id="subtitle">Loading‚Ä¶</div>
        </div>
      </div>

      <div class="controls">
        <div class="dateRow">
          <button class="btn" id="prevBtn">‚Üê Prev</button>
          <input type="date" id="dateInput" />
          <button class="btn" id="nextBtn">Next ‚Üí</button>
          <button class="btn primary" id="todayBtn">Today</button>
        </div>
        <button class="btn" id="copyBtn">Copy Slack draft</button>
        <button class="btn" id="addBtn">Add bullet</button>
        <button class="btn danger" id="resetBtn">Reset edits</button>
        <button class="btn" id="themeBtn" aria-pressed="false" title="Toggle theme">üåô</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="cardHeader">
          <h2>Accomplished today</h2>
          <div class="accompTop">
            <div class="hint" id="hintText">Draft is building‚Ä¶</div>
          </div>
        </div>
        <div class="cardBody">
          <div class="chips" id="chips"></div>

          <div class="meter">
            <div class="dot" id="covDot"></div>
            <div class="meterText" id="coverageText">Checking coverage‚Ä¶</div>
          </div>

          <div class="timeline" id="timeline"></div>
          <div class="legendRow">
            <span>00</span><span>06</span><span>12</span><span>18</span><span>23</span>
          </div>

          <div class="list" id="list"></div>

          <div style="margin-top:14px; color:var(--muted); font-size:12px;">
            Tip: click the text to edit. Use Hide if it‚Äôs noise. Receipts are under ‚ÄúShow receipts‚Äù.
          </div>
        </div>
      </div>

      <div class="rightCol">
        <div class="card" style="margin-bottom:14px;">
          <div class="cardHeader">
            <h2>Daily snapshot</h2>
            <a class="mutedLink" id="rawLink" href="#" target="_blank" rel="noreferrer">View raw JSON</a>
          </div>
          <div class="cardBody" id="snapshot">
            <div class="kv"><div class="k">Focus time</div><div class="v" id="focusTime">‚Äî</div></div>
            <div class="kv"><div class="k">Meetings</div><div class="v" id="meetTime">‚Äî</div></div>
            <div class="kv"><div class="k">Coverage window</div><div class="v" id="covWindow">‚Äî</div></div>
            <div class="kv"><div class="k">Top app</div><div class="v" id="topApp">‚Äî</div></div>
            <div class="kv"><div class="k">Top domain</div><div class="v" id="topDomain">‚Äî</div></div>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <h2>Notes for yourself</h2>
            <button class="btn" id="saveNoteBtn">Save note</button>
          </div>
          <div class="cardBody">
            <textarea id="notes" placeholder="Anything you want to remember, or context to make tomorrow easier."></textarea>
            <div class="smallNote" id="noteStatus">Saved locally per day.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copied.</div>

  <script>
    function $(id){ return document.getElementById(id); }

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1400);
    }

    function localDateKey(d = new Date()){
      const tz = d.getTimezoneOffset();
      const local = new Date(d.getTime() - tz * 60000);
      return local.toISOString().slice(0,10);
    }

    function parseLocalDate(key){
      const [y,m,d] = key.split("-").map(Number);
      return new Date(y, (m||1)-1, d||1, 12, 0, 0);
    }

    function shiftDateKey(key, deltaDays){
      const d = parseLocalDate(key);
      d.setDate(d.getDate() + deltaDays);
      return localDateKey(d);
    }

    function minutesFromHHMM(hhmm){
      if(!hhmm || typeof hhmm !== "string") return 0;
      const parts = hhmm.split(":").map(x => parseInt(x,10));
      const h = Number.isFinite(parts[0]) ? parts[0] : 0;
      const m = Number.isFinite(parts[1]) ? parts[1] : 0;
      return h * 60 + m;
    }

    function fmtMinutes(mins){
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      const hh = String(h).padStart(2,"0");
      const mm = String(m).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function prettyTimeRange(start, end){
      if(!start || !end) return "";
      const to12 = (t) => {
        const [hh,mm] = t.split(":").map(Number);
        const ampm = hh >= 12 ? "pm" : "am";
        const h12 = ((hh + 11) % 12) + 1;
        return `${h12}:${String(mm).padStart(2,"0")}${ampm}`;
      };
      return `${to12(start)}‚Äì${to12(end)}`;
    }

    function stableId(obj){
      // best effort stable key for local edits
      const s = JSON.stringify(obj);
      let h = 0;
      for(let i=0;i<s.length;i++){
        h = (h * 31 + s.charCodeAt(i)) >>> 0;
      }
      return "i" + h.toString(16);
    }

    function storageKey(dateStr){ return `da_today_v1:${dateStr}`; }
    function notesKey(dateStr){ return `da_today_notes_v1:${dateStr}`; }

    function loadEdits(dateStr){
      try{
        const raw = localStorage.getItem(storageKey(dateStr));
        return raw ? JSON.parse(raw) : null;
      }catch{ return null; }
    }
    function saveEdits(dateStr, edits){
      try{ localStorage.setItem(storageKey(dateStr), JSON.stringify(edits)); }catch{}
    }
    function clearEdits(dateStr){
      try{ localStorage.removeItem(storageKey(dateStr)); }catch{}
    }

    function loadNotes(dateStr){
      try{ return localStorage.getItem(notesKey(dateStr)) || ""; }catch{ return ""; }
    }
    function saveNotes(dateStr, val){
      try{ localStorage.setItem(notesKey(dateStr), val || ""); }catch{}
    }

    async function fetchFirstOk(candidates){
      let lastErr = null;
      for(const url of candidates){
        try{
          const r = await fetch(url, { cache: "no-store" });
          if(!r.ok) continue;
          const txt = await r.text();
          return { url, txt };
        }catch(e){
          lastErr = e;
        }
      }
      if(lastErr) throw lastErr;
      return null;
    }

    async function loadReport(dateStr){
      const t = Date.now();
      const candidates = [
        `reports/${dateStr}/ActivityReport-${dateStr}.json?t=${t}`,
        `reports/daily-report-${dateStr}.json?t=${t}`,
        `ActivityReport-${dateStr}.json?t=${t}`
      ];
      const hit = await fetchFirstOk(candidates);
      if(!hit) return { data: null, url: candidates[0] };
      try{
        return { data: JSON.parse(hit.txt), url: hit.url };
      }catch{
        return { data: null, url: hit.url };
      }
    }

    function buildAutoBullets(d){
      // Goal: Slack-ready lines that are credible, plus receipts.
      // Source: deep_work entries (best) then category totals.
      const bullets = [];
      const deep = Array.isArray(d?.deep_work) ? d.deep_work.slice() : [];
      deep.sort((a,b) => (b.minutes||0) - (a.minutes||0));

      // Create up to 5 ‚Äúblocks‚Äù
      for(const x of deep.slice(0,5)){
        const mins = x.minutes || 0;
        const label = x.label || "Work";
        const cat = x.category || "Other";
        const range = prettyTimeRange(x.start, x.end);
        bullets.push({
          kind: "deep",
          text: `Deep work: ${cat} in ${label} (${Math.round(mins)}m, ${range})`,
          receipts: [x]
        });
      }

      // Add category summary if present
      const byCat = d?.by_category && typeof d.by_category === "object" ? d.by_category : {};
      const catPairs = Object.entries(byCat)
        .map(([k,v]) => ({ k, v, mins: minutesFromHHMM(v) }))
        .filter(x => x.mins > 0)
        .sort((a,b) => b.mins - a.mins);

      if(catPairs.length){
        const top = catPairs.slice(0,4)
          .map(x => `${x.k} ${x.v}`)
          .join(", ");
        bullets.push({
          kind: "cats",
          text: `Time breakdown: ${top}`,
          receipts: catPairs.map(x => ({ label: x.k, minutes: x.mins, time: x.v }))
        });
      }

      // Add a browser highlight line if strong
      const td = d?.browser_highlights?.top_domains;
      if(Array.isArray(td) && td.length){
        const topDom = td[0];
        if(topDom?.domain && typeof topDom.visits === "number"){
          bullets.push({
            kind: "browser",
            text: `Research trail: ${topDom.domain} (${topDom.visits} visits)`,
            receipts: td.slice(0,6)
          });
        }
      }

      // Executive summary lines
      const exec = Array.isArray(d?.executive_summary) ? d.executive_summary : [];
      for(const line of exec.slice(0,2)){
        if(typeof line === "string" && line.trim()){
          bullets.push({ kind: "exec", text: line.trim(), receipts: [] });
        }
      }

      // Ensure at least one bullet
      if(!bullets.length){
        bullets.push({ kind: "manual", text: "Worked on key tasks today (add details).", receipts: [] });
      }

      return bullets;
    }

    function computeCoverage(d){
      // This is not a productivity score. It‚Äôs ‚Äúdo we have enough inputs to trust the story‚Äù.
      const sources = [];
      const hasDeep = Array.isArray(d?.deep_work) && d.deep_work.length > 0;
      const hasHourly = Array.isArray(d?.hourly_focus) && d.hourly_focus.length > 0;
      const hasDomains = Array.isArray(d?.browser_highlights?.top_domains) && d.browser_highlights.top_domains.length > 0;
      const covWindow = d?.overview?.coverage_window;

      if(hasDeep) sources.push("sessions");
      if(hasHourly) sources.push("timeline");
      if(hasDomains) sources.push("browser");
      if(covWindow) sources.push("coverage");

      let level = "bad";
      let msg = "Low coverage. Add a manual bullet so you feel safe posting.";
      if(sources.length >= 2){ level = "warn"; msg = "Partial coverage. Draft is usable, but skim receipts."; }
      if(sources.length >= 3){ level = "good"; msg = "Good coverage. Draft should be safe to post."; }

      return { level, sources, msg };
    }

    function renderTimeline(hourly){
      const el = $("timeline");
      el.innerHTML = "";
      const arr = Array.isArray(hourly) ? hourly : [];
      for(let h=0; h<24; h++){
        const obj = arr.find(x => x && x.hour === h) || arr[h] || null;
        const t = obj?.time || "00:00";
        const mins = minutesFromHHMM(t);
        const div = document.createElement("div");
        div.className = "hour" + (mins > 0 ? " on" : "");
        div.title = `${String(h).padStart(2,"0")}:00  focus ${t}`;
        el.appendChild(div);
      }
    }

    function renderChips(d){
      const chips = $("chips");
      chips.innerHTML = "";

      const focus = d?.overview?.focus_time || "00:00";
      const meet = d?.overview?.meetings_time || "00:00";
      const cov = d?.overview?.coverage_window || "‚Äî";

      const add = (label, value) => {
        const c = document.createElement("div");
        c.className = "chip";
        c.innerHTML = `${label}: <b>${value}</b>`;
        chips.appendChild(c);
      };

      add("Focus", focus);
      add("Meetings", meet);
      add("Coverage", cov);

      const deep = Array.isArray(d?.deep_work) ? d.deep_work : [];
      const deepMins = deep.reduce((a,x)=>a+(x?.minutes||0),0);
      if(deepMins > 0) add("Deep work (total)", fmtMinutes(deepMins));

      const topApps = d?.top_apps && typeof d.top_apps === "object" ? d.top_apps : {};
      const firstApp = Object.entries(topApps)[0];
      if(firstApp && firstApp[0]) add("Top app", `${firstApp[0]} ${firstApp[1] || ""}`.trim());
    }

    function applyEditsToBullets(baseBullets, edits){
      const out = [];
      const hidden = new Set(edits?.hiddenIds || []);
      const textById = edits?.textById || {};
      const manual = Array.isArray(edits?.manualBullets) ? edits.manualBullets : [];

      for(const b of baseBullets){
        const id = stableId({ kind:b.kind, text:b.text, receipts:b.receipts });
        if(hidden.has(id)) continue;
        const patched = { ...b, id };
        if(typeof textById[id] === "string") patched.text = textById[id];
        out.push(patched);
      }

      for(const m of manual){
        if(!m || typeof m.text !== "string") continue;
        const id = m.id || stableId({ kind:"manual", text:m.text });
        if(hidden.has(id)) continue;
        out.push({ kind:"manual", text:m.text, receipts: [], id });
      }

      return out;
    }

    function renderBullets(dateStr, bullets, edits, reportUrl){
      const list = $("list");
      list.innerHTML = "";

      const textById = edits?.textById || {};
      const hidden = new Set(edits?.hiddenIds || []);
      const manualBullets = Array.isArray(edits?.manualBullets) ? edits.manualBullets : [];

      function persist(){
        saveEdits(dateStr, { textById, hiddenIds: Array.from(hidden), manualBullets });
      }

      function makeItem(b){
        const wrap = document.createElement("div");
        wrap.className = "item";

        const row = document.createElement("div");
        row.className = "row";

        const left = document.createElement("div");
        left.className = "rowLeft";

        const pill = document.createElement("div");
        pill.className = "pill";
        pill.textContent = b.kind === "manual" ? "Manual" : (b.kind === "deep" ? "Deep work" : (b.kind === "cats" ? "Summary" : (b.kind === "browser" ? "Research" : "Note")));

        const text = document.createElement("div");
        text.className = "text";
        text.setAttribute("contenteditable","true");
        text.textContent = b.text;

        text.addEventListener("input", () => {
          textById[b.id] = text.textContent || "";
          persist();
          $("hintText").textContent = "Edits saved locally.";
        });

        left.appendChild(pill);
        left.appendChild(text);

        const btns = document.createElement("div");
        btns.className = "rowBtns";

        const hideBtn = document.createElement("button");
        hideBtn.className = "mini hide";
        hideBtn.textContent = "Hide";
        hideBtn.addEventListener("click", () => {
          hidden.add(b.id);
          persist();
          renderAllForDate(dateStr);
        });

        const delBtn = document.createElement("button");
        delBtn.className = "mini del";
        delBtn.textContent = "Delete";
        delBtn.title = "Delete manual bullet";
        delBtn.style.display = (b.kind === "manual" && manualBullets.find(x => x.id === b.id)) ? "inline-block" : "none";
        delBtn.addEventListener("click", () => {
          const idx = manualBullets.findIndex(x => x.id === b.id);
          if(idx >= 0) manualBullets.splice(idx,1);
          delete textById[b.id];
          persist();
          renderAllForDate(dateStr);
        });

        btns.appendChild(hideBtn);
        btns.appendChild(delBtn);

        row.appendChild(left);
        row.appendChild(btns);
        wrap.appendChild(row);

        const receipts = Array.isArray(b.receipts) ? b.receipts : [];
        const hasReceipts = receipts.length > 0;

        const det = document.createElement("details");
        const sum = document.createElement("summary");
        sum.textContent = hasReceipts ? "Show receipts" : "No receipts available";
        det.appendChild(sum);

        if(hasReceipts){
          const box = document.createElement("div");
          box.className = "receipts";

          for(const r of receipts){
            const div = document.createElement("div");
            div.className = "receipt";

            if(b.kind === "deep"){
              const range = prettyTimeRange(r.start, r.end);
              div.innerHTML = `<div><b>${r.category || "Other"}</b> in <b>${r.label || "Work"}</b> <span style="color:var(--dim)">(${range})</span></div><div><b>${Math.round(r.minutes||0)}m</b></div>`;
            } else if(b.kind === "cats"){
              div.innerHTML = `<div><b>${r.label || "Category"}</b></div><div><b>${r.time || fmtMinutes(r.minutes||0)}</b></div>`;
            } else if(b.kind === "browser"){
              const dom = r.domain || "";
              const v = typeof r.visits === "number" ? r.visits : "";
              div.innerHTML = `<div><b>${dom}</b></div><div><b>${v}</b></div>`;
            } else {
              div.innerHTML = `<div><b>Item</b></div><div><b>‚Äî</b></div>`;
            }

            box.appendChild(div);
          }

          const p = document.createElement("div");
          p.style.marginTop = "10px";
          p.style.fontSize = "12px";
          p.style.color = "var(--dim)";
          p.innerHTML = `Raw report source: <a class="mutedLink" href="${reportUrl}" target="_blank" rel="noreferrer">${reportUrl}</a>`;
          box.appendChild(p);

          det.appendChild(box);
        }

        wrap.appendChild(det);
        return wrap;
      }

      bullets.forEach(b => list.appendChild(makeItem(b)));
    }

    function slackDraft(dateStr, bullets){
      const lines = [];
      lines.push(`What did you accomplish today? (${dateStr})`);
      lines.push("");
      for(const b of bullets){
        const t = (b.text || "").trim();
        if(!t) continue;
        lines.push(`‚Ä¢ ${t}`);
      }
      return lines.join("\n");
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch{
        // Fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        let ok = false;
        try{ ok = document.execCommand("copy"); }catch{ ok = false; }
        document.body.removeChild(ta);
        return ok;
      }
    }

    function applyThemeFromStorage(){
      const saved = localStorage.getItem("da_today_theme") || "dark";
      if(saved === "light"){
        document.documentElement.classList.add("light");
        $("themeBtn").textContent = "‚òÄÔ∏è";
        $("themeBtn").setAttribute("aria-pressed","true");
      } else {
        document.documentElement.classList.remove("light");
        $("themeBtn").textContent = "üåô";
        $("themeBtn").setAttribute("aria-pressed","false");
      }
    }

    function toggleTheme(){
      const isLight = document.documentElement.classList.toggle("light");
      localStorage.setItem("da_today_theme", isLight ? "light" : "dark");
      applyThemeFromStorage();
    }

    let __cache = { dateStr: null, report: null, reportUrl: null };

    async function renderAllForDate(dateStr){
      $("subtitle").textContent = "Loading report‚Ä¶";
      $("hintText").textContent = "Draft is building‚Ä¶";
      $("list").innerHTML = "";
      $("chips").innerHTML = "";
      $("timeline").innerHTML = "";

      const { data, url } = await loadReport(dateStr);
      __cache = { dateStr, report: data, reportUrl: url };

      $("dateInput").value = dateStr;
      const u = new URL(window.location.href);
      u.searchParams.set("date", dateStr);
      history.replaceState(null, "", u.toString());

      $("notes").value = loadNotes(dateStr);
      $("noteStatus").textContent = "Saved locally per day.";

      if(!data){
        $("subtitle").textContent = `${dateStr} ‚Ä¢ No report found`;
        $("coverageText").textContent = "No report JSON found for this date. Generate a report, or pick a different day.";
        $("covDot").className = "dot bad";
        $("rawLink").href = url || "#";
        $("rawLink").textContent = "View raw JSON";
        return;
      }

      const shownDate = data.date || dateStr;
      const focus = data?.overview?.focus_time || "00:00";
      $("subtitle").textContent = `${shownDate} ‚Ä¢ Focus ${focus}`;

      // snapshot
      $("focusTime").textContent = focus;
      $("meetTime").textContent = data?.overview?.meetings_time || "00:00";
      $("covWindow").textContent = data?.overview?.coverage_window || "‚Äî";

      const topApp = Object.entries(data?.top_apps || {})[0];
      $("topApp").textContent = topApp ? `${topApp[0]} ${topApp[1] || ""}`.trim() : "‚Äî";

      const td = data?.browser_highlights?.top_domains;
      $("topDomain").textContent = Array.isArray(td) && td[0]?.domain ? td[0].domain : "‚Äî";

      $("rawLink").href = url || "#";

      renderChips(data);
      renderTimeline(data?.hourly_focus || []);

      const cov = computeCoverage(data);
      $("covDot").className = "dot " + cov.level;
      $("coverageText").textContent = cov.msg + (cov.sources.length ? ` (${cov.sources.join(", ")})` : "");

      const base = buildAutoBullets(data);
      const edits = loadEdits(dateStr) || { textById:{}, hiddenIds:[], manualBullets:[] };
      const bullets = applyEditsToBullets(base, edits);

      $("hintText").textContent = `Ready. ${bullets.length} bullets.`;

      renderBullets(dateStr, bullets, edits, url);

      // wire copy
      $("copyBtn").onclick = async () => {
        const latestEdits = loadEdits(dateStr) || { textById:{}, hiddenIds:[], manualBullets:[] };
        const b2 = applyEditsToBullets(buildAutoBullets(__cache.report), latestEdits);
        const draft = slackDraft(dateStr, b2);
        const ok = await copyToClipboard(draft);
        toast(ok ? "Copied Slack draft." : "Could not copy. Select and copy manually.");
      };
    }

    function initNav(){
      const dateInput = $("dateInput");

      const initial = new URLSearchParams(window.location.search).get("date") || localDateKey();
      dateInput.value = initial;

      $("prevBtn").addEventListener("click", () => renderAllForDate(shiftDateKey(dateInput.value, -1)));
      $("nextBtn").addEventListener("click", () => renderAllForDate(shiftDateKey(dateInput.value, 1)));
      $("todayBtn").addEventListener("click", () => renderAllForDate(localDateKey()));
      dateInput.addEventListener("change", () => renderAllForDate(dateInput.value));

      $("addBtn").addEventListener("click", () => {
        const dateStr = dateInput.value;
        const edits = loadEdits(dateStr) || { textById:{}, hiddenIds:[], manualBullets:[] };
        const id = "m" + Math.random().toString(16).slice(2);
        edits.manualBullets.push({ id, text: "New accomplishment (edit me)." });
        saveEdits(dateStr, edits);
        renderAllForDate(dateStr);
        setTimeout(() => {
          const firstEditable = document.querySelector('.text[contenteditable="true"]');
          if(firstEditable) firstEditable.focus();
        }, 50);
      });

      $("resetBtn").addEventListener("click", () => {
        const dateStr = dateInput.value;
        clearEdits(dateStr);
        renderAllForDate(dateStr);
        toast("Edits reset for this day.");
      });

      $("saveNoteBtn").addEventListener("click", () => {
        const dateStr = dateInput.value;
        saveNotes(dateStr, $("notes").value || "");
        $("noteStatus").textContent = "Saved.";
        toast("Note saved.");
        setTimeout(() => $("noteStatus").textContent = "Saved locally per day.", 1200);
      });

      $("themeBtn").addEventListener("click", toggleTheme);
    }

    (function main(){
      applyThemeFromStorage();
      initNav();
      const d = $("dateInput").value || localDateKey();
      renderAllForDate(d);
    })();
  </script>
</body>
</html>
