name: Monitor Reports

on:
  schedule:
    - cron: '0 2 * * *' # daily at 02:00 UTC
  workflow_dispatch: {}

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check recent reports
        id: check
        run: |
          set -euo pipefail
          MISSING=0
          CONSEC=0
          MAX_CONSEC=2
          for i in 1 2 3; do
            D=$(date -u -d "-$i day" +%Y-%m-%d)
            if [ ! -f "reports/$D/ActivityReport-$D.json" ]; then
              CONSEC=$((CONSEC+1))
            else
              CONSEC=0
            fi
            if [ $CONSEC -ge $MAX_CONSEC ]; then
              echo "consecutive_missing=$CONSEC" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "consecutive_missing=0" >> $GITHUB_OUTPUT

      - name: Alert on missing reports
        if: steps.check.outputs.consecutive_missing && steps.check.outputs.consecutive_missing != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const missing = parseInt(core.getInput('consecutive_missing') || process.env.GITHUB_OUTPUT.split('=')[1] || '0');
            const title = `Missing ActivityReports for ${missing} consecutive days`;
            const body = `Automatic monitor: ActivityReports were not found for the last ${missing} days. Please investigate the collector and scheduled run.`;
            const issues = await github.rest.issues.listForRepo({ owner: context.repo.owner, repo: context.repo.repo, state: 'open', labels: 'reports' });
            const existing = issues.data.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: existing.number, body: `Still missing reports as of run ${context.runId}.` });
            } else {
              await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels: ['reports','monitor'] });
            }
