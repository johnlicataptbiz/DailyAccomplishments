name: Validate Reports

on:
  push:
    branches: [ main ]

jobs:
  check-reports:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check recent reports and validate structure
        shell: bash
        run: |
          set -euo pipefail

          python3 -m pip install --upgrade pip
          python3 -m pip install jsonschema

          missing=0
          invalid=0

          regenerate_report() {
            local date="$1"
            local path="$2"

            echo "Attempting regeneration for $date"

            # Try daily generator first
            if [ -f "scripts/generate_daily_json.py" ]; then
              python3 scripts/generate_daily_json.py "$date"
            # Fallback to JSONL-based generator if available
            elif [ -f "tools/generate_reports.py" ] && [ -f "logs/daily/${date}.jsonl" ]; then
              python3 tools/generate_reports.py "$date"
            else
              echo "No suitable generator found for $date"
              return 1
            fi

            if [ -f "$path" ]; then
              echo "Regeneration produced: $path"
              return 0
            fi

            echo "Regeneration ran but did not produce: $path"
            return 1
          }

          # Validate only completed UTC days
          for i in 1 2 3; do
            date=$(date -u -d "-$i day" +%F)
            path="reports/$date/ActivityReport-$date.json"

            if [ ! -f "$path" ]; then
              echo "MISSING: $path"
              if ! regenerate_report "$date" "$path"; then
                missing=$((missing+1))
                continue
              fi
            fi

            echo "VALIDATING: $path"
            if ! python3 .github/scripts/validate_report_schema.py "$path"; then
              echo "INVALID: $path"
              invalid=$((invalid+1))
            fi
          done

          if [ "$missing" -ne 0 ] || [ "$invalid" -ne 0 ]; then
            echo "Report check failed. Missing: $missing, Invalid: $invalid"
            exit 1
          fi

          echo "All recent reports present and valid."
