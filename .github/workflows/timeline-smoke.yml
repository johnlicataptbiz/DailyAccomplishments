name: Timeline Smoke Test

on:
  pull_request:
    paths:
      - 'reports/**'
      - 'tools/**'
      - 'dashboard.html'
      - '.github/scripts/smoke_timeline.py'
      - '.github/scripts/validate_report_schema.py'

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pytest

      - name: Clean pycache and stray artifacts
        run: |
          rm -rf imports || true
          find . -name '__pycache__' -type d -prune -exec rm -rf {} +
          find . -name '*.pyc' -delete

      - name: Run validator on reports in repo
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(reports/*/ActivityReport-*.json)

          if [ ${#files[@]} -eq 0 ]; then
            echo "No reports to validate"
            exit 0
          fi

          python3 .github/scripts/validate_report_schema.py "${files[@]}"

      - name: Run timeline smoke on newest report with failsafe
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          regenerate_report() {
            local date="$1"
            local path="$2"

            echo "Attempting regeneration for $date"

            # Generate a single day report if generator supports it
            if [ -f "scripts/generate_daily_json.py" ]; then
              python3 scripts/generate_daily_json.py "$date" || true
            fi

            if [ -f "$path" ]; then
              echo "Regeneration produced: $path"
              return 0
            fi

            echo "Regeneration did not produce: $path"
            return 1
          }

          files=(reports/*/ActivityReport-*.json)

          if [ ${#files[@]} -eq 0 ]; then
            echo "No sample report found"
            exit 0
          fi

          IFS=$'\n' sorted=($(printf '%s\n' "${files[@]}" | sort))
          REPORT="${sorted[-1]}"

          # Extract date from report path (e.g., reports/2025-12-13/ActivityReport-2025-12-13.json)
          DATE=$(basename "$(dirname "$REPORT")")

          echo "Using report: $REPORT (date: $DATE)"

          # Try smoke test
          if ! python3 .github/scripts/smoke_timeline.py "$REPORT"; then
            echo "Smoke test failed for $REPORT"
            echo "Attempting report regeneration as failsafe..."
            
            if regenerate_report "$DATE" "$REPORT"; then
              echo "Regeneration succeeded, retrying smoke test..."
              if python3 .github/scripts/smoke_timeline.py "$REPORT"; then
                echo "Smoke test passed after regeneration"
                exit 0
              else
                echo "Smoke test still failed after regeneration"
                exit 1
              fi
            else
              echo "Report regeneration failed"
              exit 1
            fi
          fi

          echo "Smoke test passed"
