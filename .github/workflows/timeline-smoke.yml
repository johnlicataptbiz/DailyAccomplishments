name: Timeline Smoke Test

on:
  pull_request:
    paths:
      - "reports/**"
      - "tools/**"
      - "dashboard.html"
      - ".github/scripts/smoke_timeline.py"
      - ".github/scripts/validate_report_schema.py"
      - "scripts/**"
      - "logs/**"
      - "requirements.txt"
      - "pyproject.toml"

jobs:
  smoke:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install requirements
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install -U jsonschema pytest

      - name: Clean pycache and stray artifacts
        shell: bash
        run: |
          set -euo pipefail
          rm -rf imports || true
          find . -name '__pycache__' -type d -prune -exec rm -rf {} +
          find . -name '*.pyc' -delete

      - name: Ensure at least one report exists (generate if missing)
        id: ensure_reports
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          find_reports() {
            files=(reports/*/ActivityReport-*.json)
            if [ "${#files[@]}" -gt 0 ]; then
              echo "found=true" >> "$GITHUB_OUTPUT"
              printf '%s\n' "${files[@]}" > /tmp/reports_list.txt
              return 0
            fi
            echo "found=false" >> "$GITHUB_OUTPUT"
            return 1
          }

          echo "Checking for existing reports in repo..."
          if find_reports; then
            echo "Found existing reports."
            exit 0
          fi

          echo "No reports found. Attempting to generate reports as a fallback."

          # Fallback strategy:
          # 1) If logs/daily/*.jsonl exists, generate reports for those dates
          # 2) Else, try generating for today (UTC) using scripts/generate_daily_json.py
          generated_any=0

          if compgen -G "logs/daily/*.jsonl" > /dev/null; then
            for p in logs/daily/*.jsonl; do
              d=$(basename "$p" .jsonl)
              echo "Generating reports for date: $d"
              python3 tools/generate_reports.py "$d"
              generated_any=1
            done
          elif [ -f "scripts/generate_daily_json.py" ]; then
            d=$(date -u +%F)
            echo "Generating daily report for UTC date: $d"
            python3 scripts/generate_daily_json.py "$d"
            generated_any=1
          else
            echo "No known generation path found."
            echo "Expected logs/daily/*.jsonl + tools/generate_reports.py OR scripts/generate_daily_json.py"
            exit 1
          fi

          if [ "$generated_any" -eq 0 ]; then
            echo "Fallback generation did not run."
            exit 1
          fi

          echo "Re-checking for reports after generation..."
          if ! find_reports; then
            echo "Generation completed but no reports were produced."
            exit 1
          fi

      - name: Validate report JSON schema
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(reports/*/ActivityReport-*.json)

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No reports found even after fallback generation."
            exit 1
          fi

          python3 .github/scripts/validate_report_schema.py "${files[@]}"

      - name: Run timeline smoke on newest report
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(reports/*/ActivityReport-*.json)

          if [ "${#files[@]}" -eq 0 ]; then
            echo "No reports found to smoke test."
            exit 1
          fi

          IFS=$'\n' sorted=($(printf '%s\n' "${files[@]}" | sort))
          REPORT="${sorted[-1]}"

          echo "Using report: $REPORT"
          python3 .github/scripts/smoke_timeline.py "$REPORT"
